<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ· (Supabase Only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background:#f7f7f7; font-family:tahoma; display:flex; justify-content:center; align-items:center; height:100vh; }
    .container { background:white; padding:30px 35px; border-radius:16px; max-width:440px; box-shadow:0 12px 35px #0002; margin: 10px}
    h2 { color:#1976d2; margin-bottom:16px; }
    input,select,button { font-size:1.1em; margin:6px 0; padding:10px 10px; border-radius:7px; border:1px solid #ccc; width:100%; }
    button { background:linear-gradient(135deg,#667eea,#764ba2); color:white; font-weight:bold; border:none; cursor:pointer; }
    button:hover { background: #1976d2;}
    .result { margin-top:14px; font-weight:bold;}
    .admin { margin-top:34px;	}
    .table {width:100%; border-collapse:collapse;margin-top:18px;}
    .table th,.table td {border:1px solid #e0e0e0;padding:7px 5px;text-align:center;}
    .badge { padding: 2px 8px; border-radius: 8px; color:white; font-size: 13px;}
    .badge.in    { background: #28a745;}
    .badge.out   { background: #f44336;}
    .sm {font-size:12px;color:#888;}
  </style>
</head>
<body>
  <div class="container" id="att-container">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…ÙˆØ¸Ù)</h2>
    <input id="emp_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù" autocomplete="off">
    <button onclick="checkIn()">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/Ø§Ù†ØµØ±Ø§Ù</button>
    <div class="result" id="emp_result"></div>
    <div class="sm">Ù„Ù„Ù…Ø¯ÙŠØ±: <a href="#admin" onclick="showAdmin()">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></div>
  </div>

  <div class="container admin" id="admin-container" style="display:none;">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ‘¨â€ğŸ’¼</h2>
    <input id="admin_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø«Ø§Ù„: admin123)">
    <button onclick="adminLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <hr style="margin:14px 0 14px 0;">
    <div style="display:none;" id="dashboard">
      <h3 style="margin:12px 0;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
      <button onclick="loadAttendances()">ØªØ­Ø¯ÙŠØ« âŸ³</button>
      <div style="overflow:auto">
        <table class="table" id="att_table"><tbody></tbody></table>
      </div>
    </div>
    <div class="sm" style="margin-top:9px;">
      <a href="#" onclick="hideAdmin()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¸Ù</a>
    </div>
  </div>

  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase (ØºÙŠÙ‘Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø£Ù†Øª) ---
    const SUPABASE_URL = 'https://[YOUR_PROJECT].supabase.co';
    const SUPABASE_KEY = 'eyJh...'; // Ù…Ù† Ù„ÙˆØ­Ø© supabase -> API -> anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…ÙˆØ¸Ù ===
    async function checkIn(){
      const code = document.getElementById('emp_code').value.trim();
      if(!code) return showRes('emp_result','ğŸ”¸ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù!',true);

      let { data: emp } = await supabase.from('employees').select('id,name').eq('employee_code', code).maybeSingle();
      if(!emp) return showRes('emp_result','âŒ Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');

      // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø³Ø¬Ù„
      let { data: last } = await supabase.from('attendance').select('action').eq('employee_id',emp.id).order('time',{ascending:false}).limit(1).maybeSingle();
      let action = (last && last.action === 'checkin') ? 'checkout' : 'checkin';
      
      let { error } = await supabase.from('attendance').insert({employee_id: emp.id, action});
      showRes('emp_result',`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${action === 'checkin' ? "Ø§Ù„Ø­Ø¶ÙˆØ±" : "Ø§Ù„Ø§Ù†ØµØ±Ø§Ù"} Ù„Ù€ ${emp.name} Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
      document.getElementById('emp_code').value='';
    }

    // === Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ===
    function showAdmin(){
      document.getElementById('att-container').style.display="none";
      document.getElementById('admin-container').style.display="block";
      document.getElementById('dashboard').style.display="none";
    }
    function hideAdmin(){
      document.getElementById('att-container').style.display="block";
      document.getElementById('admin-container').style.display="none";
    }
    function showRes(id,msg,err){
      let d=document.getElementById(id); d.textContent=msg;
      d.style.color=err?'#f00':'#28a745';
    }
    // ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ù…Ø¯ÙŠØ±
    const ADMIN_PASS = "admin123";  // ØºÙŠØ±Ù‡Ø§ Ù„Ø£ÙŠ ÙƒÙ„Ù…Ø© Ø³Ø± ØªØ±ÙŠØ¯Ù‡Ø§

    function adminLogin(){
      let v = document.getElementById('admin_code').value.trim();
      if(v === ADMIN_PASS){
        document.getElementById('dashboard').style.display="";
        loadAttendances();
        showRes('admin_code','',false);
      }else{
        showRes('admin_code','âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„!',true);
      }
      document.getElementById('admin_code').value = '';
    }

    // === ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ===
    async function loadAttendances(){
      let { data: atts } = await supabase.from('attendance').select('*,employees(name,employee_code)').order('time',{ascending:false}).limit(30);
      let html = `<tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr>`;
      for(const att of atts||[]){
        let name = att.employees?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        let code = att.employees?.employee_code || '-';
        let type = att.action === 'checkin' ? 'Ø­Ø¶ÙˆØ±' : 'Ø§Ù†ØµØ±Ø§Ù';
        let badge = att.action === 'checkin' ? 'in' : 'out';
        let time = new Date(att.time).toLocaleString('ar-EG');
        html += `<tr>
          <td>${name}</td>
          <td>${code}</td>
          <td><span class="badge ${badge}">${type}</span></td>
          <td>${time}</td>
        </tr>`;
      }
      document.getElementById('att_table').innerHTML = html;
    }
  </script>
</body>
</html>
